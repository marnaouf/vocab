<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocab Test</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="js/espeakng.js"></script>
  <style>
    * {
      text-align: center
    }
  </style>
  <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/solid.min.css">
</head>

<body>
  <div id="app">
    <h1>Test your Vocabulary</h1>
    <div v-if="!started">
    <button @click.prevent="begin()">Begin</button>
    </div>
    <div v-else-if="loading">
      <h2>Loading words...</h2>
    </div>
    <div v-else>
      <h3>Do you know this word?</h3>
      <p>{{word}}</p>
      <button @click.prevent="speak(word)">Yes</button>
      <button @click.prevent="knowWord(false)">No</button>
      <h2>Score: {{score}}</h2>
      <h4>{{words.length}} words remaining...</h4>
    </div>
</div>
<script>
  console.log('Initializing Espeak');
  let tts = new eSpeakNG('js/espeakng.worker.js', function(){
    tts.set_rate(175);
    tts.set_pitch(50);
    tts.set_voice('gmw/en');
    console.log('Espeak Initialized')
  })
  let audioCtx = new window.AudioContext()  ;
  let source = audioCtx.createBufferSource();

</script>
<script>
  var app = new Vue({
    el: '#app',
    data: function() {
      return {
        started: false,
        word: 'cool',
        score: 0,
        words: [],
        loading: false,
        tts: {}
      }
    },
    methods: {
      begin() {
        this.started = true;
        this.loading = true;
        this.loadWords();
      },
      loadWords() {
        fetch('https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt')
          .then(res => {
            this.loading = true;
            return res.text()
          })
          .then(res => {
            this.words = res.split('\n');
            console.log(this.words.length)
            this.loading = false;
            this.nextWord();
          })
      },
      speak(word) {
        let samplesArr= [];
        tts.synthesize('tits', (samples, events) => {
          if (!samples) {
            const length = samplesArr.reduce((l, s) => l + s.length, 0 );
            console.log(length)
            let index = 0;
            const audioData = samplesArr.reduce((a, s) => {
              a.set(s, index);
              index += s.length;
              return a;
            }, new Uint8Array(length));
            console.log(audioData.buffer);
            audioCtx.decodeAudioData(audioData.buffer, function(buffer) {
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0)
              },
              function(e){ console.log("Error with decoding audio data" + e.err); });
            return;
          }
          // I dunno if recieving an empty samples value only happens at the end of the synthesis or if it could happen
          // at any time during synthesis so I'm going to handle it here and not in the above block
          if (samples.byteLength) samplesArr.push(new Uint8Array(samples))


        })

      },
      randomWord() {
        const i = Math.floor(Math.random() * this.words.length);
        const word = this.words[i];
        this.words.splice(i,1);
        return word;
      },
      nextWord() {
        this.word = this.randomWord()
      },

      knowWord(theyDo) {
        if (theyDo) {
          ++this.score;
        }
        this.nextWord()
      }
    }
  })
</script>
</body>
</html>
